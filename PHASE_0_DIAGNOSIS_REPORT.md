# PHASE 0: PREFLIGHT & DIAGNOSIS REPORT
**Mission:** TitleIQ Onboarding v2 + Admin Controls Fix
**Date:** 2025-10-31
**Tier:** STANDARD (21 points)

---

## ROOT CAUSE ANALYSIS

### 1. ONBOARDING AUTO-OPEN/AUTO-CLOSE BUG

**Location:** `/frontend/src/components/OnboardingGate.jsx` lines 11-13

**Root Cause:**
```javascript
useEffect(() => {
  checkOnboardingStatus();
}, []); // Empty dependency array
```

**Problem:**
- `OnboardingGate` wraps protected routes (Dashboard, Settings, AdminDashboard)
- When navigating between routes (e.g., Admin → User Dashboard), the component remounts
- Each mount triggers `checkOnboardingStatus()` which calls the API
- If API returns `shouldShow: true`, onboarding modal flashes open then immediately closes
- This happens because:
  1. Route change causes remount
  2. API check runs
  3. State updates trigger render
  4. Immediate navigation to new route unmounts component

**Evidence:** App.jsx lines 38-40 show OnboardingGate wrapping multiple routes:
```javascript
<Route path="/dashboard" element={<OnboardingGate><Dashboard /></OnboardingGate>} />
<Route path="/settings" element={<OnboardingGate><Settings /></OnboardingGate>} />
<Route path="/admin" element={<OnboardingGate><AdminDashboard /></OnboardingGate>} />
```

**Fix Required:**
- Move onboarding state to global context (AuthContext)
- Check onboarding status ONCE on app load
- Add explicit state machine with route-aware guards
- Prevent automatic modal opening during route transitions

---

### 2. NO RE-LAUNCH MECHANISM

**Current Behavior:**
- Onboarding runs once (first login)
- After completion/skip, no way to access it again
- No menu entry or trigger

**Missing Components:**
- Menu entry in Navbar.jsx (currently no "Onboarding" link)
- Pulsating indicator for users who skipped
- Re-launch endpoint or state reset

**Required:**
- Add "Onboarding" menu item in Navbar
- Add pulsating indicator (CSS animation)
- Modal-based re-launch (doesn't gate the app)
- Pre-fill last saved answers

---

### 3. ADMIN CONTROLS INCOMPLETE

**Location:** `/frontend/src/pages/AdminDashboard.jsx` lines 126-193

**Current Implementation:**
- Grant Pro Lifetime: Works (lines 126-156)
- Revoke Pro Lifetime: Works (lines 158-193)
- **MISSING:** Upgrade user to different plans (creator, creator_pro)
- **MISSING:** Suspend account functionality
- **MISSING:** Confirmation modals (uses browser `prompt()` and `confirm()`)
- **MISSING:** Audit logging

**Issues:**
- No visual confirmation modals (unprofessional UX)
- No success/error toasts
- No audit trail for admin actions
- Cannot upgrade users to paid plans
- Cannot suspend/restore accounts

**Backend Missing:**
- `/api/admin/users/:id/upgrade` endpoint
- `/api/admin/users/:id/suspend` endpoint
- `/api/admin/users/:id/restore` endpoint
- `admin_action_audit` table in database

---

### 4. HOMEPAGE CTA LOGIC SCATTERED

**Location:** `/frontend/src/pages/HomePage.jsx` (uses hardcoded links)

**Current Issues:**
- Lines 28-33: Hardcoded "Try Builder Mode" and "Sign Up Free" links
- No auth state check
- Doesn't show "Go to App" for logged-in users
- CTA logic not centralized

**Navbar CTA:** Lines 45-76 in Navbar.jsx correctly check auth state
- Shows "Start Free Trial" when logged out
- Shows "Dashboard" link when logged in
- But HomePage doesn't follow same pattern

**Fix Required:**
- Create `useAuthCTA()` hook
- Single source of truth for auth state
- Homepage consumes from hook
- Show "Go to App" button for authenticated users

---

### 5. TITLE/DESCRIPTION BUILDERS MISSING

**Current Implementation:**
- `/backend/routes/generate.js` generates titles BUT:
  - No character cap enforcement (line 121: just slices array)
  - No title formatting with brand/channel/episode
  - No smart truncation logic
  - Description template is basic (generated by LLM without structure)

**Missing Features:**
- Title builder function with:
  - 100-char cap
  - Format: `Core | Brand | Channel | Ep. N`
  - Smart truncation (preserve core, drop optional elements)
  - De-duplication
- Description builder with:
  - Structured template (Key Takeaways, Resources, Social Links, Credits)
  - Hashtag cap (≤ 10 tags)
  - SEO optimization
  - Link sanitization

**Onboarding Profile Data Missing:**
- Backend has columns: `niche`, `brand_voice`, `primary_goal`, `social_links`, `hashtags`, `keywords`, `competitors`
- But missing: `channel_name`, `podcast_name`, `episode_number_preference`, `include_brand_in_title`, `include_channel_in_title`, `include_episode_in_title`

---

### 6. PIN COMMENT RECOMMENDER (NEW FEATURE)

**Status:** Not implemented

**Required:**
- New endpoint: `/api/generate/pin-comment`
- Input: transcript, user profile, generated titles
- Output: 1 suggested pin comment (≤150 chars)
- Logic: Hook-first, question/CTA, personality match, mobile-optimized

---

## DATA CONTRACTS

### Onboarding Profile Schema (ENHANCED)

**Current columns in `users` table:**
```sql
niche TEXT,
brand_voice TEXT,
primary_goal TEXT,
social_links TEXT, -- JSON
hashtags TEXT, -- JSON
keywords TEXT, -- JSON
competitors TEXT, -- JSON
onboarding_completed INTEGER DEFAULT 0,
onboarding_step INTEGER DEFAULT 0,
onboarding_data TEXT -- JSON blob
```

**NEW columns needed:**
```sql
channel_name TEXT,
podcast_name TEXT,
brand_name TEXT,
website_url TEXT,
include_brand_in_title INTEGER DEFAULT 1,
include_channel_in_title INTEGER DEFAULT 1,
include_episode_in_title INTEGER DEFAULT 1
```

### Admin Action Audit Table (NEW)

```sql
CREATE TABLE IF NOT EXISTS admin_action_audit (
  id TEXT PRIMARY KEY,
  admin_id TEXT NOT NULL,
  action TEXT NOT NULL, -- 'upgrade_user', 'suspend_account', 'restore_account', 'revoke_grant'
  target_user_id TEXT NOT NULL,
  metadata TEXT, -- JSON: { from_plan, to_plan, reason, notes }
  timestamp INTEGER NOT NULL,
  FOREIGN KEY (admin_id) REFERENCES users(id),
  FOREIGN KEY (target_user_id) REFERENCES users(id)
);

CREATE INDEX IF NOT EXISTS idx_admin_audit_admin ON admin_action_audit(admin_id);
CREATE INDEX IF NOT EXISTS idx_admin_audit_target ON admin_action_audit(target_user_id);
CREATE INDEX IF NOT EXISTS idx_admin_audit_timestamp ON admin_action_audit(timestamp);
```

### Pin Comment Recommendation Table (NEW)

```sql
CREATE TABLE IF NOT EXISTS pin_comment_recommendations (
  id TEXT PRIMARY KEY,
  generation_id TEXT NOT NULL,
  comment_text TEXT NOT NULL,
  engagement_score INTEGER, -- Predicted score 1-100
  reasoning TEXT, -- Why this comment was chosen
  created_at INTEGER NOT NULL,
  FOREIGN KEY (generation_id) REFERENCES user_generations(id)
);
```

---

## ACCEPTANCE CRITERIA

### Onboarding V2
- ✅ First-run gating: Blocks app until complete/skip
- ✅ Modal-based: Backdrop lock, professional animations
- ✅ Progress indicator: Visual ring, step counter
- ✅ Data capture: All 12 steps from existing wizard PLUS new fields (channel name, brand name, title preferences)
- ✅ Skip option: Always visible, doesn't lose progress
- ✅ Resume capability: Save after each step
- ✅ Menu entry: "Onboarding" link in Navbar with pulsating indicator
- ✅ Re-launch: Opens as modal, pre-fills data, doesn't block app
- ✅ Admin-safe: Admin users can run onboarding without affecting admin state
- ✅ No race conditions: Admin → User Dashboard switch doesn't trigger auto-open/close

### Title Builder
- ✅ Character cap: ≤ 100 characters (YouTube standard)
- ✅ Format: `Core Title | Brand | Channel | Ep. N`
- ✅ Smart truncation: Prioritize core, drop optional elements, never mid-word
- ✅ De-duplication: If Brand === Channel, show once
- ✅ User toggles: Include Brand, Channel, Episode (stored in profile)
- ✅ API integration: Called during generation, uses profile data

### Description Builder
- ✅ Structured template: Lead lines, Key Takeaways, Resources, Social Links, Credits, Hashtags
- ✅ Hashtag cap: ≤ 10 tags
- ✅ Link sanitization: Remove XSS vectors, validate URLs
- ✅ SEO optimization: Front-load keywords in first 2 lines
- ✅ Social links: Auto-populate from onboarding profile
- ✅ Emoji section headers: For visual appeal

### Homepage CTA
- ✅ Logged out: "Start Free Trial" button
- ✅ Logged in: "Go to App" button
- ✅ Single source: `useAuthCTA()` hook
- ✅ Consistent: All CTAs use same logic

### Admin Controls
- ✅ Upgrade user: Modal confirmation, plan selection dropdown, success toast
- ✅ Suspend account: Modal with reason dropdown, reversible
- ✅ Restore account: Button appears for suspended users
- ✅ Visual feedback: Toasts, badges, status indicators
- ✅ Audit logging: All actions logged with admin_id, user_id, metadata, timestamp
- ✅ Immutable logs: Cannot be deleted or edited

### Pin Comment Recommender
- ✅ Hook-first: First 5 words grab attention
- ✅ Question or CTA: Drives engagement
- ✅ Character limit: ≤ 150 chars (mobile-friendly)
- ✅ Personality match: Uses brand_voice from profile
- ✅ API endpoint: `/api/generate/pin-comment`
- ✅ Saved: Stored in pin_comment_recommendations table

---

## RISK REGISTER

### HIGH RISK
1. **Database Migration Failure**
   - Impact: App breaks if new columns not added correctly
   - Mitigation: Test migration on local copy first, backup production DB before deploy
   - Rollback: Revert migration script, restore backup

2. **Onboarding State Race Conditions**
   - Impact: Users get stuck in onboarding loop
   - Mitigation: Comprehensive state machine testing, E2E tests for all route transitions
   - Rollback: Feature flag `onboarding_v2=false`

### MEDIUM RISK
3. **Title Truncation Edge Cases**
   - Impact: Titles broken mid-word, special characters cause issues
   - Mitigation: Unit tests with 50+ edge cases (emoji, special chars, multi-byte chars)
   - Rollback: Fall back to simple slice if truncation fails

4. **Admin Action Audit Log Gaps**
   - Impact: Compliance issue if actions not logged
   - Mitigation: Transactions (log BEFORE action, commit together), alerts on log failures
   - Rollback: Manual audit reconstruction from database backups

### LOW RISK
5. **Performance Degradation (New Features)**
   - Impact: Slower load times
   - Mitigation: Lazy load onboarding modal, index audit table, cache user profiles
   - Rollback: Feature flags per feature

---

## FILES TO MODIFY

### Frontend
- `src/components/OnboardingWizard.jsx` - Add new fields (channel name, title toggles)
- `src/components/OnboardingGate.jsx` - Remove auto-check, integrate with global state
- `src/components/OnboardingModal.jsx` - NEW: Modal wrapper for re-launch
- `src/components/Navbar.jsx` - Add "Onboarding" menu entry with pulse
- `src/pages/HomePage.jsx` - Use `useAuthCTA()` hook
- `src/pages/Home.jsx` - Same as above (check if duplicate)
- `src/pages/AdminDashboard.jsx` - Add upgrade/suspend modals, improve UX
- `src/hooks/useAuthCTA.jsx` - NEW: Centralized CTA logic
- `src/context/AuthContext.jsx` - Add onboarding state management
- `src/styles/pulse-indicator.css` - NEW: Pulsating animation

### Backend
- `routes/onboarding.js` - Add re-launch endpoint, new fields
- `routes/generate.js` - Integrate title/description builders
- `routes/admin.js` - Add upgrade/suspend/restore endpoints
- `routes/recommendations.js` - NEW: Pin comment endpoint
- `utils/titleBuilder.js` - NEW: Title formatting logic
- `utils/descriptionBuilder.js` - NEW: Description template logic
- `utils/db.js` - Add new tables, columns
- `migrations/add-onboarding-v2-columns.sql` - NEW: Migration script
- `migrations/add-admin-audit-table.sql` - NEW: Migration script
- `migrations/add-pin-comment-table.sql` - NEW: Migration script

---

## NEXT STEPS (PHASE 1)

**Ready to proceed to Phase 1: Spec & Prototype**

Deliverables:
1. UI specs for onboarding modal (screens, animations, progress ring)
2. Pulsating menu indicator design
3. Celebration "poof" animation parameters
4. Reduced-motion variants
5. Admin modal designs (upgrade, suspend)
6. Event taxonomy for tracking
7. Accessibility annotations

**Estimated Time:** 2-3 hours
**Agents:** catalyst-ui-enforcer, system-architect

---

## STATUS: PHASE 0 COMPLETE ✅

All root causes identified, data contracts defined, acceptance criteria documented, risks catalogued. Ready for implementation planning.
